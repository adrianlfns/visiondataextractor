@using VisionDataExtractor.Models
@using System.Linq
@using System.Text.Json
@inject IJSRuntime JSRuntime


<div class="bg-white rounded-lg shadow-lg p-6 mb-6 transition-all duration-300">
    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
        <h2 class="text-2xl font-semibold text-gray-700">3. Data Fields</h2>
        <div class="flex gap-2 flex-wrap">
            <button @onclick="AddDataField" class="bg-green-500 text-white font-bold py-1.5 px-3 rounded-lg hover:bg-green-600 transition-colors inline-flex items-center gap-2 text-sm whitespace-nowrap">
                    <i data-lucide="plus" class="w-5 h-5"></i>
                    <span class="hidden sm:inline">Add Field</span>
                    <span class="sm:hidden">Add</span>
            </button>
            
            <button @onclick="ShowSaveTemplateModal" disabled="@IsIncompleteOrProcessing" class="bg-blue-500 text-white font-bold py-1.5 px-3 rounded-lg hover:bg-blue-600 transition-colors inline-flex items-center gap-2 text-sm whitespace-nowrap disabled:opacity-50 disabled:cursor-not-allowed">
                <i data-lucide="save" class="w-5 h-5"></i>
                <span class="hidden sm:inline">Save Template</span>
                <span class="sm:hidden">Save</span>
            </button>
        </div>
    </div>
    
    <!-- Load Template Dropdown -->
    @if (SavedTemplates.Count > 0)
    {
        <div class="mb-4">
            <select @onchange="LoadTemplate" class="w-full sm:w-auto px-3 py-1.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                <option value="">-- Load Template --</option>
                @foreach (JsonElement template in SavedTemplates)
                {
                    <option value="@template.ToString()">@template.GetProperty("TemplateName")</option>
                }
            </select>
        </div>
    }

    <!-- Save Template Modal -->
    @if (ShowSaveModal)
    {
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg shadow-lg p-6 max-w-sm mx-4">
                <h3 class="text-lg font-semibold mb-4">Save Field Template</h3>
                <input type="text" placeholder="Enter template name" @bind="TemplateNameInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-4 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm" />
                <div class="flex gap-3 justify-end">
                   <button @onclick="ConfirmSaveTemplate" disabled="@string.IsNullOrWhiteSpace(TemplateNameInput)" class="bg-blue-500 text-white font-bold py-1 px-4 rounded-lg hover:bg-blue-600 disabled:opacity-50">Save</button>
                   <button @onclick="CancelSaveTemplate" class="bg-gray-300 text-gray-800 font-bold py-1 px-4 rounded-lg hover:bg-gray-400">Cancel</button>
                </div>
            </div>
        </div>
    }

    <div class="space-y-4">
        @foreach (var field in Fields)
        {
            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 relative group">
                @if (Fields.Count > 1)
                {
                    <div class="flex justify-end mb">
                        <button @onclick="() => RequestRemoveDataField(field.Id)" title="Remove field" class="bg-red-50 text-red-700 hover:bg-red-100 border border-red-200 rounded-full p-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-red-300 transition-colors" aria-label="Remove field">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    </div>
                }
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Field Name</label>
                        <input type="text" placeholder="e.g., ProductName" value="@field.Name" @oninput="(e) => UpdateDataFieldName(field.Id, e.Value?.ToString())" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Extraction Prompt</label>
                        <textarea placeholder="e.g., What is the product name?" value="@field.Prompt" @oninput="(e) => UpdateDataFieldPrompt(field.Id, e.Value?.ToString())" rows="2" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                    </div>
                </div>
                    @if (FieldToRemove == field.Id)
                {
                    <div class="absolute inset-0 bg-white bg-opacity-95 flex flex-col items-center justify-center rounded-lg">
                        <p class="font-semibold mb-3">Remove this field?</p>
                        <div class="flex gap-4">
                            <button @onclick="() => ConfirmRemoveDataField(true)" class="bg-red-500 text-white font-bold py-1 px-4 rounded-lg hover:bg-red-600">Yes</button>
                            <button @onclick="() => ConfirmRemoveDataField(false)" class="bg-gray-300 text-gray-800 font-bold py-1 px-4 rounded-lg hover:bg-gray-400">No</button>
                        </div>
                    </div>
                }
            </div>
        }
    </div>

    <div class="mt-6">
        <button @onclick="OnExtractDataClick" disabled="@IsIncompleteOrProcessing" class="w-full bg-indigo-600 text-white font-bold py-2 px-3 rounded-lg hover:bg-indigo-700 transition-colors flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed text-sm whitespace-nowrap" >
            @if (IsProcessing)
            {
                <svg class="animate-spin -ml-1 mr-2 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="hidden sm:inline">Extracting Data...</span>
                <span class="sm:hidden">Extracting...</span>
            }
            else
            {
                <i data-lucide="wand-sparks" class="w-5 h-5 mr-2"></i>
                <span class="hidden sm:inline">Extract Data</span>
                <span class="sm:hidden">Extract</span>
            }
        </button>
    </div>
</div>


@code {
    [Parameter]
    public List<DataField> Fields { get; set; } = new();

    [Parameter]
    public EventCallback<List<DataField>> FieldsChanged { get; set; }

    [Parameter]
    public bool IsProcessing { get; set; }

    [Parameter]
    public EventCallback OnExtractData { get; set; }

    private Guid FieldToRemove { get; set; } = Guid.Empty;
    private bool ShowSaveModal { get; set; } = false;
    private string TemplateNameInput { get; set; } = "";
    private IJSObjectReference? _storageModule;
    private List<System.Text.Json.JsonElement> SavedTemplates { get; set; } = new List<JsonElement>();

    private bool IsIncompleteOrProcessing
    {
        get
        {
            if (IsProcessing)
            {
                return true;
            }

            if (!Fields.Any())
            {
                return true;
            }
            return Fields.Any(f => string.IsNullOrWhiteSpace(f.Name) || string.IsNullOrWhiteSpace(f.Prompt));
        }
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _storageModule = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./js/fieldStorage.js");
            await RefreshTemplateList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading storage module: {ex.Message}");
        }
    }

    private async Task RefreshTemplateList()
    {
        try
        {
            if (_storageModule != null)
            {
                SavedTemplates = await _storageModule.InvokeAsync<List<System.Text.Json.JsonElement>>("listTemplates");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error refreshing template list: {ex.Message}");
        }
    }

    private void ShowSaveTemplateModal()
    {
        TemplateNameInput = "";
        ShowSaveModal = true;
    }

    private void CancelSaveTemplate()
    {
        ShowSaveModal = false;
        TemplateNameInput = "";
    }

    private async Task ConfirmSaveTemplate()
    {
        if (string.IsNullOrWhiteSpace(TemplateNameInput) || _storageModule == null)
            return;

        try
        {
            // Prepare field data for storage (use lowercase keys 'name' and 'prompt')
            var fieldsToSave = Fields.Select(f => new Dictionary<string, string>
            {
                ["name"] = f.Name ?? string.Empty,
                ["prompt"] = f.Prompt ?? string.Empty
            }).ToList();

            // Save template as object { TemplateName, Fields }
            await _storageModule.InvokeVoidAsync("saveTemplate", TemplateNameInput, fieldsToSave);
            await RefreshTemplateList();
            ShowSaveModal = false;
            TemplateNameInput = "";
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving template: {ex.Message}");
        }
    }

    private async Task LoadTemplate(ChangeEventArgs e)
    {
        string? strValue = e?.Value?.ToString();
        if (string.IsNullOrEmpty(strValue))
            return;

        try
        {
            using (JsonDocument document = System.Text.Json.JsonDocument.Parse(strValue))
            {
                JsonElement root =  document.RootElement;
                if (root.TryGetProperty("Fields", out var fieldsArray) && fieldsArray.ValueKind == System.Text.Json.JsonValueKind.Array)
                {
                      Fields.Clear();
                      foreach (var item in fieldsArray.EnumerateArray())
                      {
                            if (item.ValueKind == System.Text.Json.JsonValueKind.Object)
                            {
                                // accept either lowercase or PascalCase keys
                                string name = string.Empty, prompt = string.Empty;
                                if (item.TryGetProperty("name", out var n1)) name = n1.GetString() ?? string.Empty;
                                else if (item.TryGetProperty("Name", out var n2)) name = n2.GetString() ?? string.Empty;

                                if (item.TryGetProperty("prompt", out var p1)) prompt = p1.GetString() ?? string.Empty;
                                else if (item.TryGetProperty("Prompt", out var p2)) prompt = p2.GetString() ?? string.Empty;

                                Fields.Add(new DataField { Name = name, Prompt = prompt });
                            }
                      }

                      await FieldsChanged.InvokeAsync(Fields);
                      StateHasChanged();
                }
            }          

            // Fetch the full templates object and pick the named entry
           /* var templatesElement = await _storageModule.InvokeAsync<System.Text.Json.JsonElement>("getTemplates");

            if (templatesElement.ValueKind == System.Text.Json.JsonValueKind.Object &&
                templatesElement.TryGetProperty(templateName, out var templateObj) &&
                templateObj.ValueKind == System.Text.Json.JsonValueKind.Object)
            {
                // The stored shape is { TemplateName: "name", Fields: [ ... ] }
                if (templateObj.TryGetProperty("Fields", out var fieldsArray) && fieldsArray.ValueKind == System.Text.Json.JsonValueKind.Array)
                {
                    Fields.Clear();

                    foreach (var item in fieldsArray.EnumerateArray())
                    {
                        if (item.ValueKind == System.Text.Json.JsonValueKind.Object)
                        {
                            // accept either lowercase or PascalCase keys
                            string name = string.Empty, prompt = string.Empty;
                            if (item.TryGetProperty("name", out var n1)) name = n1.GetString() ?? string.Empty;
                            else if (item.TryGetProperty("Name", out var n2)) name = n2.GetString() ?? string.Empty;

                            if (item.TryGetProperty("prompt", out var p1)) prompt = p1.GetString() ?? string.Empty;
                            else if (item.TryGetProperty("Prompt", out var p2)) prompt = p2.GetString() ?? string.Empty;

                            Fields.Add(new DataField { Name = name, Prompt = prompt });
                        }
                    }

                    await FieldsChanged.InvokeAsync(Fields);
                    StateHasChanged();
                }
            }*/
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading template: {ex.Message}");
        }
    }

    private void AddDataField()
    {
        Fields.Add(new DataField { Name = "", Prompt = "" });
        FieldsChanged.InvokeAsync(Fields);
    }

    private void RequestRemoveDataField(Guid id)
    {
        FieldToRemove = id;
    }

    private async Task ConfirmRemoveDataField(bool confirmed)
    {
        if (confirmed)
        {
            Fields.RemoveAll(f => f.Id == FieldToRemove);
            await FieldsChanged.InvokeAsync(Fields);
        }
        FieldToRemove = Guid.Empty;
    }

    private async Task UpdateDataFieldName(Guid id, string? value)
    {
        var field = Fields.FirstOrDefault(f => f.Id == id);
        if (field != null)
        {
            field.Name = value;
            await FieldsChanged.InvokeAsync(Fields);
        }
    }

    private async Task UpdateDataFieldPrompt(Guid id, string? value)
    {
        var field = Fields.FirstOrDefault(f => f.Id == id);
        if (field != null)
        {
            field.Prompt = value;
            await FieldsChanged.InvokeAsync(Fields);
        }
    }

    private async Task OnExtractDataClick()
    {
        await OnExtractData.InvokeAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // Ensure Lucide icons are (re)created for dynamic content
        try
        {
            await JSRuntime.InvokeVoidAsync("lucide.createIcons");
        }
        catch
        {
            // Ignore if lucide is not available; page will still function
        }
    }
}
