@using Microsoft.AspNetCore.Components.Forms
@using VisionDataExtractor.Models
@inject IJSRuntime JSRuntime

<div class="bg-white rounded-lg shadow-lg p-6 mb-6 transition-all duration-300">
    <h2 class="text-2xl font-semibold text-gray-700 mb-4">2. Upload Image</h2>

    <!-- Hidden file input always present so we can replace image via upload -->
    <InputFile id="@fileInputId" OnChange="HandleImageUpload" accept="image/*" class="sr-only" aria-label="Upload image" />

    @if (string.IsNullOrEmpty(UploadedImage) || _showCameraPreview)
    {
        @if (!_showCameraPreview)
        {
            <!-- Initial state: two buttons side-by-side -->
            <div class="flex flex-wrap justify-center gap-3">
                <label for="@fileInputId" class="inline-flex items-center gap-2 bg-blue-500 text-white rounded-md py-1.5 px-3 text-sm font-medium hover:bg-blue-600 shadow-sm whitespace-nowrap">
                    <i data-lucide="upload" class="w-5 h-5"></i>
                    <span class="hidden sm:inline">Upload Image</span>
                    <span class="sm:hidden">Upload</span>
                </label>

                <button @onclick="StartCameraPreview" class="inline-flex items-center gap-2 bg-blue-500 text-white rounded-md py-1.5 px-3 text-sm font-medium hover:bg-blue-600 shadow-sm whitespace-nowrap">
                    <i data-lucide="camera" class="w-5 h-5"></i>
                    <span class="hidden sm:inline">Capture from Camera</span>
                    <span class="sm:hidden">Capture</span>
                </button>
            </div>
        }
        else
        {
            <!-- Camera preview active -->
            <div class="space-y-4">
                <div id="@_cameraContainerId" class="w-full bg-black rounded-lg"></div>

                <div class="flex justify-center gap-3">
                    <button @onclick="CapturePhotoFromCamera" class="bg-green-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-600 transition-colors flex items-center">
                        <i data-lucide="camera" class="w-5 h-5 mr-2"></i> Capture
                    </button>
                    <button @onclick="StopCameraPreview" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600 transition-colors">
                        Cancel
                    </button>
                </div>
            </div>
        }
    }
    else
    {
        <!-- Image displayed with buttons underneath -->
        <div class="w-full flex flex-col items-center">
            <div class="w-full flex justify-center">
                <img src="@UploadedImage" alt="@ImageName" class="max-h-96 w-auto rounded-lg shadow-md" />
            </div>

            <div class="mt-4 flex flex-wrap justify-center gap-3">
                <label for="@fileInputId" class="inline-flex items-center gap-2 bg-blue-500 text-white rounded-md py-1.5 px-3 text-sm font-medium hover:bg-blue-600 shadow-sm whitespace-nowrap">
                    <i data-lucide="upload" class="w-5 h-5"></i>
                    <span class="hidden sm:inline">Upload Image</span>
                    <span class="sm:hidden">Upload</span>
                </label>

                <button @onclick="StartCameraPreview" class="inline-flex items-center gap-2 bg-blue-500 text-white rounded-md py-1.5 px-3 text-sm font-medium hover:bg-blue-600 shadow-sm whitespace-nowrap">
                    <i data-lucide="camera" class="w-5 h-5"></i>
                    <span class="hidden sm:inline">Capture from Camera</span>
                    <span class="sm:hidden">Capture</span>
                </button>

                <button @onclick="ClearImage" class="inline-flex items-center gap-2 bg-red-500 text-white rounded-md py-1.5 px-3 text-sm font-medium hover:bg-red-600 shadow-sm whitespace-nowrap">
                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                    <span>Remove</span>
                </button>
            </div>

            @if (showClearImageConfirm)
            {
                <div class="mt-3 w-full flex justify-center">
                    <div class="bg-white p-4 rounded-md shadow-md">
                        <p class="font-semibold mb-2">Are you sure?</p>
                        <div class="flex gap-4">
                            <button @onclick="() => ConfirmClearImage(true)" class="bg-red-500 text-white font-bold py-1 px-4 rounded-lg hover:bg-red-600">Yes</button>
                            <button @onclick="() => ConfirmClearImage(false)" class="bg-gray-300 text-gray-800 font-bold py-1 px-4 rounded-lg hover:bg-gray-400">No</button>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>


@code {

    private readonly string fileInputId = "file-upload-" + System.Guid.NewGuid().ToString("N");
    private readonly string _cameraContainerId = "camera-container-" + System.Guid.NewGuid().ToString("N");
    private IJSObjectReference? _cameraModule;
    private bool _showCameraPreview = false;

    [Parameter]
    public string? UploadedImage { get; set; }

    [Parameter]
    public EventCallback<string?> UploadedImageChanged { get; set; }

    [Parameter]
    public string? ImageName { get; set; }

    [Parameter]
    public EventCallback<string?> ImageNameChanged { get; set; }

    private bool showClearImageConfirm = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _cameraModule = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./js/cameraCapture.js");
        }
        catch
        {
            // Module will be loaded on-demand if import fails here
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("lucide.createIcons");
        }
        catch
        {
            // Icon library may not be loaded yet
        }
    }

    private async Task HandleImageUpload(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null) return;

        if (!file.ContentType.StartsWith("image/"))
        {
            // local validation only; parent maintains its own error state
            return;
        }

        if (file.Size > 10 * 1024 * 1024) // 10 MB
        {
            return;
        }

        try
        {
            await using var stream = file.OpenReadStream(file.Size);
            await using var ms = new System.IO.MemoryStream();
            await stream.CopyToAsync(ms);
            var buffer = ms.ToArray();
            UploadedImage = $"data:{file.ContentType};base64,{Convert.ToBase64String(buffer)}";
            ImageName = file.Name;
            await UploadedImageChanged.InvokeAsync(UploadedImage);
            await ImageNameChanged.InvokeAsync(ImageName);
        }
        catch
        {
            // swallow here; parent will handle any global errors
        }
        finally
        {
            StateHasChanged();
        }
    }

    private async Task StartCameraPreview()
    {
        try
        {
            // Set flag FIRST so the container gets rendered
            _showCameraPreview = true;
            StateHasChanged();

            // Wait for the render to complete
            await Task.Delay(100);

            // THEN ensure module is loaded and start camera
            _cameraModule ??= await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./js/cameraCapture.js");

            // Start camera
            await _cameraModule.InvokeAsync<bool>("startCamera", _cameraContainerId);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Start camera error: {ex.Message}");
            _showCameraPreview = false;
        }
        finally
        {
            StateHasChanged();
        }
    }

    private async Task StopCameraPreview()
    {
        try
        {
            if (_cameraModule != null)
            {
                await _cameraModule.InvokeVoidAsync("stopCamera");
            }
        }
        catch { }
        finally
        {
            _showCameraPreview = false;
            StateHasChanged();
        }
    }

    private async Task CapturePhotoFromCamera()
    {
        try
        {
            if (_cameraModule == null) return;

            // Capture photo as data URL
            var dataUrl = await _cameraModule.InvokeAsync<string>("capturePhoto");
            
            if (!string.IsNullOrEmpty(dataUrl))
            {
                UploadedImage = dataUrl;
                ImageName = "camera-" + System.DateTime.Now.ToString("yyyyMMdd-HHmmss") + ".jpg";
                await UploadedImageChanged.InvokeAsync(UploadedImage);
                await ImageNameChanged.InvokeAsync(ImageName);
                
                // Stop camera and go back to image view
                try
                {
                    if (_cameraModule != null)
                    {
                        await _cameraModule.InvokeVoidAsync("stopCamera");
                    }
                }
                catch { }
                
                _showCameraPreview = false;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Capture error: {ex.Message}");
        }
        finally
        {
            StateHasChanged();
        }
    }

    private void ClearImage()
    {
        showClearImageConfirm = true;
    }

    private async Task ConfirmClearImage(bool confirmed)
    {
        if (confirmed)
        {
            UploadedImage = null;
            ImageName = null;
            await UploadedImageChanged.InvokeAsync(UploadedImage);
            await ImageNameChanged.InvokeAsync(ImageName);
        }
        showClearImageConfirm = false;
    }

}

