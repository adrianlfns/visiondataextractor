@using Microsoft.AspNetCore.Components.Forms
@using VisionDataExtractor.Models

<div class="bg-white rounded-lg shadow-lg p-6 mb-6 transition-all duration-300">
    <h2 class="text-2xl font-semibold text-gray-700 mb-4">2. Upload Image</h2>
    @if (string.IsNullOrEmpty(UploadedImage))
    {
        <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md">
            <div class="space-y-1 text-center">
                    <i data-lucide="upload-cloud" class="mx-auto h-12 w-12 text-gray-400"></i>
                <div class="flex text-sm text-gray-600">
                    <label for="file-upload" class="relative cursor-pointer bg-white rounded-md font-medium text-indigo-600 hover:text-indigo-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-indigo-500">
                        <span>Click to upload image</span>
                        <InputFile id="file-upload" OnChange="HandleImageUpload" accept="image/*" class="sr-only" aria-label="Upload image"/>
                    </label>
                </div>
                <p class="text-xs text-gray-500">PNG, JPG, GIF up to 10MB</p>
            </div>
        </div>
    }
    else
    {
        <div class="relative group">
            <img src="@UploadedImage" alt="@ImageName" class="max-h-96 w-auto mx-auto rounded-lg shadow-md" />
            <button @onclick="ClearImage" disabled="@showClearImageConfirm" class="absolute top-2 right-2 bg-black bg-opacity-50 text-white rounded-full p-1.5 opacity-0 group-hover:opacity-100 transition-opacity disabled:opacity-50" aria-label="Remove image">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
            @if (showClearImageConfirm)
            {
                <div class="absolute inset-0 bg-white bg-opacity-90 flex flex-col items-center justify-center rounded-lg">
                    <p class="font-semibold mb-3">Are you sure?</p>
                    <div class="flex gap-4">
                        <button @onclick="() => ConfirmClearImage(true)" class="bg-red-500 text-white font-bold py-1 px-4 rounded-lg hover:bg-red-600">Yes</button>
                        <button @onclick="() => ConfirmClearImage(false)" class="bg-gray-300 text-gray-800 font-bold py-1 px-4 rounded-lg hover:bg-gray-400">No</button>
                    </div>
                </div>
            }
        </div>
    }
</div>


@code {

    [Parameter]
    public string? UploadedImage { get; set; }

    [Parameter]
    public EventCallback<string?> UploadedImageChanged { get; set; }

    [Parameter]
    public string? ImageName { get; set; }

    [Parameter]
    public EventCallback<string?> ImageNameChanged { get; set; }

    private bool showClearImageConfirm = false;

    private async Task HandleImageUpload(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null) return;

        if (!file.ContentType.StartsWith("image/"))
        {
            // local validation only; parent maintains its own error state
            return;
        }

        if (file.Size > 10 * 1024 * 1024) // 10 MB
        {
            return;
        }

        try
        {
            await using var stream = file.OpenReadStream(file.Size);
            await using var ms = new System.IO.MemoryStream();
            await stream.CopyToAsync(ms);
            var buffer = ms.ToArray();
            UploadedImage = $"data:{file.ContentType};base64,{Convert.ToBase64String(buffer)}";
            ImageName = file.Name;
            await UploadedImageChanged.InvokeAsync(UploadedImage);
            await ImageNameChanged.InvokeAsync(ImageName);
        }
        catch
        {
            // swallow here; parent will handle any global errors
        }
        finally
        {
            StateHasChanged();
        }
    }

    private void ClearImage()
    {
        showClearImageConfirm = true;
    }

    private async Task ConfirmClearImage(bool confirmed)
    {
        if (confirmed)
        {
            UploadedImage = null;
            ImageName = null;
            await UploadedImageChanged.InvokeAsync(UploadedImage);
            await ImageNameChanged.InvokeAsync(ImageName);
        }
        showClearImageConfirm = false;
    }
}
