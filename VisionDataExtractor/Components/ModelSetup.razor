@using System.Text.Json
@using Microsoft.JSInterop
@using VisionDataExtractor.Models
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
 

<div class="bg-white rounded-lg shadow-lg p-6 mb-6 transition-all duration-300">
    <h2 class="text-2xl font-semibold text-gray-700 mb-4">1. Model Setup</h2>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
        <div class="md:col-span-2">
            <label for="model-select" class="block text-sm font-medium text-gray-700 mb-1">Select Model</label>
            <select id="model-select" value="@selectedModel" @onchange="OnSelectedModelChanged"
                    class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
                    disabled="@(ModelStatus == ModelStatus.Downloading)"
                    aria-label="Select AI Model">
                @foreach (var model in availableModels)
                {
                    <option value="@model.Id">@model.Name (@model.Size)</option>
                }
            </select>
        </div>
        <div class="w-full flex items-center justify-center md:justify-end h-full">
            @if (ModelStatus == ModelStatus.NotLoaded)
            {
                <button @onclick="DownloadModelAsync" class="w-full md:w-auto bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors flex items-center justify-center">
                    <i data-lucide="download" class="w-5 h-5 mr-2"></i> Download Model
                </button>
            }
            else if (ModelStatus == ModelStatus.Downloading)
            {
                <div class="w-full text-center">
                    <div class="flex items-center justify-center text-sm text-gray-600">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Downloading...
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                        <div class="bg-blue-600 h-2.5 rounded-full" style="width: @(downloadProgress)%"></div>
                    </div>
                    <p class="text-xs text-blue-600 font-semibold mt-1">@downloadProgress%</p>
                </div>
            }
            else if (ModelStatus == ModelStatus.Ready)
            {
                <div class="flex items-center text-green-600 font-semibold">
                    <i data-lucide="check-circle" class="w-5 h-5 mr-2"></i> Model Ready
                </div>
            }
            else if (ModelStatus == ModelStatus.Error)
            {
                <div class="flex items-center text-red-600 font-semibold">
                     <i data-lucide="alert-triangle" class="w-5 h-5 mr-2"></i> Error
                </div>
            }
        </div>
    </div>

    @if (!string.IsNullOrEmpty(localErrorMessage) && ModelStatus == ModelStatus.Error)
    {
        <p class="text-red-500 text-sm mt-2 whitespace-pre-wrap">@localErrorMessage</p>
    }
</div>

@code {
    [Parameter]
    public ModelStatus ModelStatus { get; set; } = ModelStatus.NotLoaded;

    [Parameter]
    public EventCallback<ModelStatus> ModelStatusChanged { get; set; }

    private class ModelOption
    {
        public required string Id { get; set; }
        public required string Name { get; set; }
        public required string Size { get; set; }
    }

    private List<ModelOption> availableModels = new List<ModelOption>
    {
        new ModelOption { Id = "HuggingFaceTB/SmolVLM-256M-Instruct", Name = "SmolVLM-256M (WebGPU)", Size = "~500MB" },
        new ModelOption { Id = "HuggingFaceTB/SmolVLM-500M-Instruct", Name = "SmolVLM-500M (WebGPU)", Size = "~1GB" }
    };

    private string selectedModel = "HuggingFaceTB/SmolVLM-256M-Instruct";
    private int downloadProgress = 0;
    private DotNetObjectReference<ModelSetup>? dotNetRef;
    private string? localErrorMessage;

    protected override async Task OnInitializedAsync()
    {
        dotNetRef = DotNetObjectReference.Create(this);
        await TryAutoLoadModel(selectedModel);
    }

    public async Task DownloadModelAsync()
    {
        await SetModelStatus(ModelStatus.Downloading);
        localErrorMessage = null;
        try
        {
            if (dotNetRef == null)
            {
                localErrorMessage = "Component reference is not initialized.";
                await SetModelStatus(ModelStatus.Error);
                return;
            }
            using CancellationTokenSource timeoutCts = new CancellationTokenSource(TimeSpan.FromMinutes(15));
            var result = await JSRuntime.InvokeAsync<JsonElement>("visionInterop.loadModel", timeoutCts.Token, new object[] { selectedModel, dotNetRef });

            if (result.ValueKind == JsonValueKind.True)
            {
                await SetModelStatus(ModelStatus.Ready);
            }
            else if (result.ValueKind == JsonValueKind.Object && result.TryGetProperty("error", out var errorElement))
            {
                localErrorMessage = errorElement.GetString();
                await SetModelStatus(ModelStatus.Error);
            }
            else
            {
                localErrorMessage = "Model download failed due to an unknown error. Check browser console.";
                await SetModelStatus(ModelStatus.Error);
            }
        }
        catch (JSException ex)
        {
            localErrorMessage = $"JavaScript error during model download: {ex.Message}";
            await SetModelStatus(ModelStatus.Error);
        }
        catch (OperationCanceledException)
        {
            localErrorMessage = "The model download timed out. Please check your network connection and try again.";
            await SetModelStatus(ModelStatus.Error);
        }
    }

    private async Task OnSelectedModelChanged(ChangeEventArgs e)
    {
        var newValue = e?.Value?.ToString();
        if (string.IsNullOrEmpty(newValue) || newValue == selectedModel)
            return;

        selectedModel = newValue;
        localErrorMessage = null;

        // If a download is in progress, do nothing
        if (ModelStatus == ModelStatus.Downloading)
            return;

        var loaded = await TryAutoLoadModel(selectedModel);
        if (!loaded)
        {
            await SetModelStatus(ModelStatus.NotLoaded);
        }
    }

    private async Task<bool> TryAutoLoadModel(string modelId)
    {
        try
        {
            var isCached = await JSRuntime.InvokeAsync<bool>("visionInterop.isModelCached", modelId);
            if (!isCached)
                return false;

            var loaded = await JSRuntime.InvokeAsync<JsonElement>("visionInterop.loadModel", modelId);
            if (loaded.ValueKind == JsonValueKind.True)
            {
                await SetModelStatus(ModelStatus.Ready);
                return true;
            }
            else if (loaded.ValueKind == JsonValueKind.Object && loaded.TryGetProperty("error", out var err))
            {
                localErrorMessage = err.GetString();
                await SetModelStatus(ModelStatus.Error);
                return false;
            }

            return false;
        }
        catch (JSException ex)
        {
            localErrorMessage = $"JavaScript error: {ex.Message}";
            await SetModelStatus(ModelStatus.Error);
            return false;
        }
        catch (Exception ex)
        {
            localErrorMessage = $"Error: {ex.Message}";
            await SetModelStatus(ModelStatus.Error);
            return false;
        }
    }

    private async Task SetModelStatus(ModelStatus newStatus)
    {
        ModelStatus = newStatus;
        await ModelStatusChanged.InvokeAsync(newStatus);
        StateHasChanged();
    }

    [JSInvokable]
    public void UpdateProgress(int progress)
    {
        downloadProgress = progress;
        StateHasChanged();
    }

    public async ValueTask DisposeAsync()
    {
        dotNetRef?.Dispose();
        GC.SuppressFinalize(this);
        await Task.CompletedTask;
    }
}