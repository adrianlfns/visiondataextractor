@page "/"
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
@using VisionDataExtractor.Models
@using Microsoft.JSInterop
@using Microsoft.AspNetCore.Components.Forms
@using System.Linq
@using System.Text.Json
@using System.IO
@implements IAsyncDisposable
@using VisionDataExtractor.Models
@using VisionDataExtractor.Components

<div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 font-sans">
    <main class="max-w-4xl mx-auto p-4 md:p-6 lg:p-8">
        <ErrorBoundary>
            <ChildContent>
                <!-- Header -->
                <header class="text-center mb-8">
                    <h1 class="text-4xl md:text-5xl font-bold text-gray-800">Vision Data Extractor</h1>
                    <p class="text-lg text-gray-600 mt-2">Extract structured data from images using AI (WebGPU Accelerated)</p>
                </header>

                <!-- Section 1: Model Setup -->         
                <ModelSetup @bind-ModelStatus="modelStatus" />

                <!-- Section 2: Upload Image -->
                @if (modelStatus == ModelStatus.Ready)
                {
                    <div class="bg-white rounded-lg shadow-lg p-6 mb-6 transition-all duration-300">
                        <h2 class="text-2xl font-semibold text-gray-700 mb-4">2. Upload Image</h2>
                        @if (string.IsNullOrEmpty(uploadedImage))
                        {
                            <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md">
                                <div class="space-y-1 text-center">
                                     <i data-lucide="upload-cloud" class="mx-auto h-12 w-12 text-gray-400"></i>
                                    <div class="flex text-sm text-gray-600">
                                        <label for="file-upload" class="relative cursor-pointer bg-white rounded-md font-medium text-indigo-600 hover:text-indigo-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-indigo-500">
                                            <span>Click to upload image</span>
                                            <InputFile id="file-upload" OnChange="HandleImageUpload" accept="image/*" class="sr-only" aria-label="Upload image"/>
                                        </label>
                                    </div>
                                    <p class="text-xs text-gray-500">PNG, JPG, GIF up to 10MB</p>
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="relative group">
                                <img src="@uploadedImage" alt="@imageName" class="max-h-96 w-auto mx-auto rounded-lg shadow-md" />
                                <button @onclick="ClearImageAsync" disabled="@showClearImageConfirm" class="absolute top-2 right-2 bg-black bg-opacity-50 text-white rounded-full p-1.5 opacity-0 group-hover:opacity-100 transition-opacity disabled:opacity-50" aria-label="Remove image">
                                    <i data-lucide="x" class="w-5 h-5"></i>
                                </button>
                                @if (showClearImageConfirm)
                                {
                                    <div class="absolute inset-0 bg-white bg-opacity-90 flex flex-col items-center justify-center rounded-lg">
                                        <p class="font-semibold mb-3">Are you sure?</p>
                                        <div class="flex gap-4">
                                            <button @onclick="() => ConfirmClearImage(true)" class="bg-red-500 text-white font-bold py-1 px-4 rounded-lg hover:bg-red-600">Yes</button>
                                            <button @onclick="() => ConfirmClearImage(false)" class="bg-gray-300 text-gray-800 font-bold py-1 px-4 rounded-lg hover:bg-gray-400">No</button>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                }

                <!-- Section 3: Configure Data Fields -->
                @if (!string.IsNullOrEmpty(uploadedImage))
                {
                    <div class="bg-white rounded-lg shadow-lg p-6 mb-6 transition-all duration-300">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-semibold text-gray-700">3. Data Fields</h2>
                            <button @onclick="AddDataField" class="bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors flex items-center">
                                 <i data-lucide="plus" class="w-5 h-5 mr-1"></i> Add Field
                            </button>
                        </div>
                        
                        <div class="space-y-4">
                            @foreach (var field in dataFields)
                            {
                                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 relative group">
                                    @if (dataFields.Count > 1)
                                    {
                                        <button @onclick="() => RequestRemoveDataField(field.Id)" class="absolute top-2 right-2 text-gray-400 hover:text-red-500 opacity-50 group-hover:opacity-100 transition-opacity" aria-label="Remove field">
                                            <i data-lucide="x-circle" class="w-5 h-5"></i>
                                        </button>
                                    }
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Field Name</label>
                                            <input type="text" placeholder="e.g., ProductName" value="@field.Name" @oninput="(e) => UpdateDataFieldName(field.Id, (string)e.Value)" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" />
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Extraction Prompt</label>
                                            <textarea placeholder="e.g., What is the product name?" value="@field.Prompt" @oninput="(e) => UpdateDataFieldPrompt(field.Id, (string)e.Value)" rows="2" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                                        </div>
                                    </div>
                                     @if (fieldToRemove == field.Id)
                                    {
                                        <div class="absolute inset-0 bg-white bg-opacity-95 flex flex-col items-center justify-center rounded-lg">
                                            <p class="font-semibold mb-3">Remove this field?</p>
                                            <div class="flex gap-4">
                                                <button @onclick="() => ConfirmRemoveDataField(true)" class="bg-red-500 text-white font-bold py-1 px-4 rounded-lg hover:bg-red-600">Yes</button>
                                                <button @onclick="() => ConfirmRemoveDataField(false)" class="bg-gray-300 text-gray-800 font-bold py-1 px-4 rounded-lg hover:bg-gray-400">No</button>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                        </div>

                        <div class="mt-6">
                            <button @onclick="ExtractDataAsync" disabled="@IsIncompleteOrProcessing" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-colors flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed" >
                                @if (isProcessing)
                                {
                                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    <span>Extracting Data...</span>
                                }
                                else
                                {
                                    <i data-lucide="wand-sparks" class="w-5 h-5 mr-2"></i>
                                    <span>Extract Data</span>
                                }
                            </button>
                        </div>
                    </div>
                }

                <!-- Section 4: Results -->
                @if (extractedData.Any())
                {
                    <div class="bg-white rounded-lg shadow-lg p-6 mb-6 transition-all duration-300">
                         <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-semibold text-gray-700">4. Extracted Data</h2>
                            <button @onclick="DownloadJsonAsync" class="bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-600 transition-colors flex items-center">
                                 <i data-lucide="download" class="w-5 h-5 mr-2"></i> Download JSON
                            </button>
                        </div>
                        
                        <div class="space-y-4 mb-6">
                            @foreach (var kvp in extractedData)
                            {
                                <div>
                                    <h3 class="font-semibold text-gray-600">@kvp.Key</h3>
                                    <div class="mt-1 p-3 bg-gray-100 rounded-md w-full text-gray-800 border border-gray-200">
                                        @kvp.Value
                                    </div>
                                </div>
                            }
                        </div>

                        <div>
                            <h3 class="font-semibold text-gray-600 mb-2">JSON Preview</h3>
                            <div class="bg-gray-800 text-white p-4 rounded-lg text-sm font-mono overflow-x-auto">
                                <pre><code>@((new ExtractionResult { ImageName = imageName, ExtractedData = extractedData, DataFields = dataFields }).ToJson())</code></pre>
                            </div>
                        </div>
                    </div>
                }
            </ChildContent>
            <ErrorContent>
                 <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg shadow-lg" role="alert">
                    <h3 class="font-bold">An unexpected error occurred.</h3>
                    <p>We apologize for the inconvenience. Please try refreshing the page.</p>
                    <button @onclick="RetryPage" class="mt-3 bg-red-500 text-white font-bold py-2 px-4 rounded hover:bg-red-600 transition-colors">Retry</button>
                </div>
            </ErrorContent>
        </ErrorBoundary>

        <!-- Footer -->
        <footer class="text-center mt-8">
            <p class="text-xs text-gray-500">
                Powered by Blazor WebAssembly & <a href="https://huggingface.co/docs/transformers.js" target="_blank" class="text-indigo-500 hover:underline">Transformers.js</a>
            </p>
        </footer>
    </main>
</div>

@code {
  

    private class ModelOption
    {
        public string Id { get; set; }
        public string Name { get; set; }
        public string Size { get; set; }
    }

    private ModelStatus modelStatus {get; set;} = ModelStatus.NotLoaded;
 

    private string? uploadedImage;
    private string? imageName;
    private List<DataField> dataFields = new List<DataField>
    {
        new DataField { Name = "InvoiceNumber", Prompt = "What is the invoice number?" }
    };
    private Dictionary<string, string> extractedData = new Dictionary<string, string>();
    private bool isProcessing = false;

    private bool IsIncompleteOrProcessing {
        get{
            if (isProcessing)
            {
                return true;
            }

            if (!dataFields.Any())
            {
                return true;
            }
            return dataFields.Any(f => string.IsNullOrWhiteSpace(f.Name) || string.IsNullOrWhiteSpace(f.Prompt));
        }
    }

    private string? errorMessage;
    private bool showClearImageConfirm = false;
    private Guid fieldToRemove = Guid.Empty;

 

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
           await JSRuntime.InvokeVoidAsync("lucide.createIcons");
        }
    }

  

    private async Task HandleImageUpload(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null) return;

        if (!file.ContentType.StartsWith("image/"))
        {
            errorMessage = "Please upload a valid image file.";
            StateHasChanged();
            return;
        }

        if (file.Size > 10 * 1024 * 1024) // 10 MB
        {
            errorMessage = "Image size cannot exceed 10 MB.";
            StateHasChanged();
            return;
        }

        try
        {
            await using var stream = file.OpenReadStream(file.Size);
            await using var ms = new MemoryStream();
            await stream.CopyToAsync(ms);
            var buffer = ms.ToArray();
            uploadedImage = $"data:{file.ContentType};base64,{Convert.ToBase64String(buffer)}";
            imageName = file.Name;
            extractedData.Clear();
            errorMessage = null; 
        }
        catch (Exception ex)
        {
            errorMessage = $"Error processing image: {ex.Message}";
        }
        finally
        {
            StateHasChanged();
        }
    }

    private void AddDataField()
    {
        dataFields.Add(new DataField { Name = "", Prompt = "" });
    }

    private void RequestRemoveDataField(Guid id)
    {
        fieldToRemove = id;
    }

    private void ConfirmRemoveDataField(bool confirmed)
    {
        if (confirmed)
        {
            dataFields.RemoveAll(f => f.Id == fieldToRemove);
        }
        fieldToRemove = Guid.Empty;
    }

    private void UpdateDataFieldName(Guid id, string value)
    {
        var field = dataFields.FirstOrDefault(f => f.Id == id);
        if (field != null)
        {
            field.Name = value;
        }
    }

    private void UpdateDataFieldPrompt(Guid id, string value)
    {
        var field = dataFields.FirstOrDefault(f => f.Id == id);
        if (field != null)
        { 
            field.Prompt = value;
        }
    }

    private async Task ExtractDataAsync()
    {
        if (string.IsNullOrEmpty(uploadedImage) || modelStatus != ModelStatus.Ready) return;

        var validFields = dataFields.Where(f => !string.IsNullOrWhiteSpace(f.Name) && !string.IsNullOrWhiteSpace(f.Prompt)).ToList();
        if (!validFields.Any()) return;

        isProcessing = true;
        errorMessage = null;
        extractedData.Clear();
        StateHasChanged();

        try
        {
            foreach (var field in validFields)
            {
                var resultElement = await JSRuntime.InvokeAsync<JsonElement>("visionInterop.extractData", uploadedImage, field.Prompt);
                
                if (resultElement.ValueKind == JsonValueKind.String)
                {
                    extractedData[field.Name] = resultElement.GetString();
                }
                else if (resultElement.TryGetProperty("error", out var errorElement))
                {
                    extractedData[field.Name] = $"Error: {errorElement.GetString()}";
                }
                else
                {
                    extractedData[field.Name] = "Extraction failed with an unknown error.";
                }
                StateHasChanged();
            }
        }
        catch (JSException ex)
        {
            errorMessage = $"Error during data extraction: {ex.Message}";
        }
        finally
        {
            isProcessing = false;
        }
    }

    private async Task DownloadJsonAsync()
    {
        if (!extractedData.Any()) return;

        var result = new ExtractionResult
        {
            ImageName = imageName,
            ExtractedData = extractedData,
            DataFields = dataFields.Where(f => !string.IsNullOrWhiteSpace(f.Name)).ToList()
        };

        var json = result.ToJson();
        var timestamp = DateTime.UtcNow.ToString("yyyyMMddHHmmss");
        var filename = $"vision-data-{timestamp}.json";

        try
        {
            await JSRuntime.InvokeVoidAsync("visionInterop.downloadFile", filename, json);
        }
        catch (JSException ex)
        {
            errorMessage = $"Error downloading JSON file: {ex.Message}";
        }
    }

    private void ClearImageAsync()
    {
        showClearImageConfirm = true;
    }

    private void ConfirmClearImage(bool confirmed)
    {
        if (confirmed)
        {
            uploadedImage = null;
            imageName = null;
            extractedData.Clear();
            errorMessage = null;
        }
        showClearImageConfirm = false;
    }

    public async ValueTask DisposeAsync()
    {        
        GC.SuppressFinalize(this);
        await Task.CompletedTask;
    }

    private void RetryPage()
    {
        Navigation.NavigateTo(Navigation.Uri, forceLoad: true);
    }
}