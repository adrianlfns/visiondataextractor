@page "/"
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
@using VisionDataExtractor.Models
@using Microsoft.JSInterop
@using Microsoft.AspNetCore.Components.Forms
@using System.Linq
@using System.Text.Json
@using System.IO
@implements IAsyncDisposable
@using VisionDataExtractor.Components

<div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 font-sans">
    <main class="max-w-4xl mx-auto p-4 md:p-6 lg:p-8">
        <ErrorBoundary>
            <ChildContent>
                <!-- Header -->
                <header class="text-center mb-8">
                    <h1 class="text-4xl md:text-5xl font-bold text-gray-800">Vision Data Extractor</h1>
                    <p class="text-lg text-gray-600 mt-2">Extract structured data from images using AI (WebGPU Accelerated)</p>
                </header>

                <!-- Section 1: Model Setup -->         
                <ModelSetup @bind-ModelStatus="modelStatus" />

                <!-- Section 2: Upload Image -->
                @if(modelStatus == ModelStatus.Ready)
                {
                   <UploadImage @bind-UploadedImage="uploadedImage" @bind-ImageName="imageName" />
                }

                <!-- Section 3: Configure Data Fields -->
                @if (!string.IsNullOrEmpty(uploadedImage))
                {
                 <DataFields @bind-Fields="dataFields" IsProcessing="@isProcessing" OnExtractData="ExtractDataAsync" />
                }
                
                <!-- Section 4: Results -->
                @if (extractedData.Any())
                {
                    <div class="bg-white rounded-lg shadow-lg p-6 mb-6 transition-all duration-300">
                         <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-semibold text-gray-700">4. Extracted Data</h2>
                            <button @onclick="DownloadJsonAsync" class="bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-600 transition-colors flex items-center">
                                 <i data-lucide="download" class="w-5 h-5 mr-2"></i> Download JSON
                            </button>
                        </div>
                        
                        <div class="space-y-4 mb-6">
                            @foreach (var kvp in extractedData)
                            {
                                <div>
                                    <h3 class="font-semibold text-gray-600">@kvp.Key</h3>
                                    <div class="mt-1 p-3 bg-gray-100 rounded-md w-full text-gray-800 border border-gray-200">
                                        @kvp.Value
                                    </div>
                                </div>
                            }
                        </div>

                        <div>
                            <h3 class="font-semibold text-gray-600 mb-2">JSON Preview</h3>
                            <div class="bg-gray-800 text-white p-4 rounded-lg text-sm font-mono overflow-x-auto">
                                <pre><code>@((new ExtractionResult { ImageName = imageName, ExtractedData = extractedData, DataFields = dataFields }).ToJson())</code></pre>
                            </div>
                        </div>
                    </div>
                }
            </ChildContent>
            <ErrorContent>
                 <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg shadow-lg" role="alert">
                    <h3 class="font-bold">An unexpected error occurred.</h3>
                    <p>We apologize for the inconvenience. Please try refreshing the page.</p>
                    <button @onclick="RetryPage" class="mt-3 bg-red-500 text-white font-bold py-2 px-4 rounded hover:bg-red-600 transition-colors">Retry</button>
                </div>
            </ErrorContent>
        </ErrorBoundary>

        <!-- Footer -->
        <footer class="text-center mt-8">
            <p class="text-xs text-gray-500">
                Powered by Blazor WebAssembly & <a href="https://huggingface.co/docs/transformers.js" target="_blank" class="text-indigo-500 hover:underline">Transformers.js</a>
            </p>
        </footer>
    </main>
</div>

@code {
  

    private ModelStatus modelStatus {get; set;} = ModelStatus.NotLoaded;
 

    private string? uploadedImage;
    private string? imageName;
    private List<DataField> dataFields = new List<DataField>
    {
        new DataField { Name = "InvoiceNumber", Prompt = "What is the invoice number?" }
    };
    private Dictionary<string, string> extractedData = new Dictionary<string, string>();
    private bool isProcessing = false;

    private string? errorMessage;

 

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
           await JSRuntime.InvokeVoidAsync("lucide.createIcons");
        }
    }

  


    // Data field management handled in the `DataFields` component (bound to `dataFields`).

    private async Task ExtractDataAsync()
    {
        if (string.IsNullOrEmpty(uploadedImage) || modelStatus != ModelStatus.Ready) return;

        var validFields = dataFields.Where(f => !string.IsNullOrWhiteSpace(f.Name) && !string.IsNullOrWhiteSpace(f.Prompt)).ToList();
        if (!validFields.Any()) return;

        isProcessing = true;
        errorMessage = null;
        extractedData.Clear();
        StateHasChanged();

        try
        {
            foreach (var field in validFields)
            {
                var fieldName = field.Name ?? "Unknown";
                var resultElement = await JSRuntime.InvokeAsync<JsonElement>("visionInterop.extractData", uploadedImage, field.Prompt);
                
                if (resultElement.ValueKind == JsonValueKind.String)
                {
                    extractedData[fieldName] = resultElement.GetString() ?? "";
                }
                else if (resultElement.TryGetProperty("error", out var errorElement))
                {
                    extractedData[fieldName] = $"Error: {errorElement.GetString()}";
                }
                else
                {
                    extractedData[fieldName] = "Extraction failed with an unknown error.";
                }
                StateHasChanged();
            }
        }
        catch (JSException ex)
        {
            errorMessage = $"Error during data extraction: {ex.Message}";
        }
        finally
        {
            isProcessing = false;
        }
    }

    private async Task DownloadJsonAsync()
    {
        if (!extractedData.Any()) return;

        var result = new ExtractionResult
        {
            ImageName = imageName,
            ExtractedData = extractedData,
            DataFields = dataFields.Where(f => !string.IsNullOrWhiteSpace(f.Name)).ToList()
        };

        var json = result.ToJson();
        var timestamp = DateTime.UtcNow.ToString("yyyyMMddHHmmss");
        var filename = $"vision-data-{timestamp}.json";

        try
        {
            await JSRuntime.InvokeVoidAsync("visionInterop.downloadFile", filename, json);
        }
        catch (JSException ex)
        {
            errorMessage = $"Error downloading JSON file: {ex.Message}";
        }
    }

    // Image upload/clear handled in the `UploadImage` component (bound to `uploadedImage` and `imageName`).

    public async ValueTask DisposeAsync()
    {        
        GC.SuppressFinalize(this);
        await Task.CompletedTask;
    }

    private void RetryPage()
    {
        Navigation.NavigateTo(Navigation.Uri, forceLoad: true);
    }
}